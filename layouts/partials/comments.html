<div class="comments">
    <hr>
    <h3>Comments</h3>
    <p id="mastodon-comments-loading">Loading comments from the Fediverse...</p>
    <div id="comments-wrapper"></div>
    <p>Replies to <a class="link" href="https://mastodon.social/@natanfreeman/{{ .Params.mastodon_post_id }}">this Mastodon post</a> are synchronized here as comments.</p>

    <style>
        .comment { margin-bottom: 1.5em; border-bottom: 1px solid var(--border); padding-bottom: 1em; }
        .comment-header { display: flex; align-items: center; margin-bottom: 0.5em; }
        .comment-avatar { width: 48px; height: 48px; border-radius: 4px; margin-right: 12px; }
        .comment-author { font-weight: bold; }
        .comment-content { font-size: 0.95em; }
        .comment-content p { margin: 0.5em 0; }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <script type="text/javascript">
        const postId = "{{ .Params.mastodon_post_id }}";
        const instance = "mastodon.social";
        const username = "natanfreeman";
        const domains = ["natansessays.com", "NatanFreeman.github.io/essays"];
        const pageTitle = "{{ .Title }}";
        const urlPath = window.location.pathname;

        async function loadComments() {
            const wrapper = document.getElementById('comments-wrapper');
            const loading = document.getElementById('mastodon-comments-loading');
            
            try {
                let targetId = postId;

                // 1. If no ID, try to find the post by searching the user's statuses
                if (!targetId) {
                    const accountResponse = await fetch(`https://${instance}/api/v1/accounts/lookup?acct=${username}`);
                    const account = await accountResponse.json();
                    const accountId = account.id;

                    // Increase limit to 100 to find older posts
                    const statusesResponse = await fetch(`https://${instance}/api/v1/accounts/${accountId}/statuses?limit=100`);
                    const statuses = await statusesResponse.json();

                    const pathParts = urlPath.split('/').filter(p => p.length > 0);
                    const slug = pathParts[pathParts.length - 1];

                    // Find a status that matches our criteria
                    const match = statuses.find(s => {
                        const content = s.content || "";
                        const cardUrl = (s.card && s.card.url) ? s.card.url : "";
                        
                        if (!slug) return false;

                        const slugMatch = content.includes(slug) || cardUrl.includes(slug);
                        const domainMatch = domains.some(d => content.includes(d) || cardUrl.includes(d));
                        const titleMatch = content.includes(pageTitle);

                        return (slugMatch && domainMatch) || titleMatch;
                    });

                    if (match) {
                        targetId = match.id;
                    }
                }

                if (!targetId) {
                    loading.style.display = 'none';
                    wrapper.innerHTML = '<p>No linked Mastodon post found for this page.</p>';
                    return;
                }

                // Update the link in the footer
                const postLink = document.querySelector('.comments a.link');
                if (postLink) postLink.href = `https://${instance}/@${username}/${targetId}`;

                // 2. Fetch comments (context)
                const contextResponse = await fetch(`https://${instance}/api/v1/statuses/${targetId}/context`);
                const data = await contextResponse.json();

                loading.style.display = 'none';

                if (data.descendants && data.descendants.length > 0) {
                    data.descendants.forEach(reply => {
                        const comment = document.createElement('div');
                        comment.className = 'comment';
                        const content = DOMPurify.sanitize(reply.content);
                        comment.innerHTML = `
                            <div class="comment-header">
                                <img class="comment-avatar" src="${reply.account.avatar}" alt="${reply.account.display_name}">
                                <div>
                                    <div class="comment-author">${reply.account.display_name}</div>
                                    <div class="comment-meta"><a href="${reply.url}" target="_blank">@${reply.account.acct}</a></div>
                                </div>
                            </div>
                            <div class="comment-content">${content}</div>
                        `;
                        wrapper.appendChild(comment);
                    });
                } else {
                    wrapper.innerHTML = '<p>No comments yet. Be the first to reply on Mastodon!</p>';
                }
            } catch (err) {
                loading.innerText = 'Error loading comments.';
                console.error(err);
            }
        }

        loadComments();
    </script>
</div>
